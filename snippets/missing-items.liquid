{%- if settings.mia_enable and customer -%}
  {%- liquid
    assign mia_quantity = 0
    assign mia_tag_prefix = settings.mia_tag_prefix | downcase | strip
    assign customer_has_mia_tags = false

    for tag in customer.tags
      assign current_tag = tag | downcase | strip

      if current_tag contains mia_tag_prefix
        assign mia_quantity = current_tag | split: '::' | last | times: 1
        assign customer_has_mia_tags = true
      endif
    endfor
  -%}
  {%- if customer_has_mia_tags -%}
    <missing-items
      id="MissingItems-Core"
      data-mia-product="{{ settings.mia_product.id }}"
      data-mia-variant="{{ settings.mia_product.selected_or_first_available_variant.id }}"
      data-mia-tag-prefix="{{ settings.mia_tag_prefix | downcase | strip }}"
      data-mia-quantity="{{ mia_quantity }}"
      {% if settings.mia_product.selected_or_first_available_variant.available and settings.mia_product.selected_or_first_available_variant.inventory_quantity >= mia_quantity %}
      data-mia-is-available
      {% endif %}
      {% if settings.mia_product.tags contains '_is-exclusive' %}
      data-mia-is-exclusive
      {% endif %}
    >
      {%- assign customer_email = customer.email | downcase | sha256 -%}
      {%- form 'product',
        settings.mia_product,
        id: 'FormMissingItems',
        class: 'form gwp-form hidden',
        novalidate: 'novalidate',
        data-type: 'mia-form',
        data-customer: customer_email,
        data-store-country: shop.metafields.settings.main.shop_country
      -%}
        <input type="hidden" name="id" value="{{ settings.mia_product.first_available_variant.id }}">
        <input type="hidden" name="quantity" value="{{ mia_quantity }}">
      {%- endform -%}
    </missing-items>

    <script src="{{ 'missing-items.js' | asset_url }}" defer></script>
  {%- endif -%}
{%- endif -%}
